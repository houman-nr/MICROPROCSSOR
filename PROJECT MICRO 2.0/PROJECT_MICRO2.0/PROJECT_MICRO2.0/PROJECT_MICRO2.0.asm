/*
 * PROJECT_MICRO2.asm
 *
 *  Created: 1/19/2023 3:17:34 PM
 *   Author: houman
 */ 

	.INCLUDE "M32DEF.INC"
	.ORG 0
	RJMP main
	.ORG $100
	.DB $10, $24, $02, $15 ;50 / 100 / 10 / 65
	.ORG $200
MAIN:	LDI R16, $00
		OUT DDRA, R16; PORTA IS NOW BEING USED AS IN INPUT
		OUT SFIOR, R16; PULL UP RESISTANT
		IN R24, PINA
		LDI R16, $0F
		OUT DDRB, R16;SETTING THE 
		OUT DDRC, R16; OUTPUT PORTS
		OUT DDRD, R16; FIRST 4 BIT PORT ARE USED FOR
		LDI R16, $00
		OUT PORTB, R16
		LDI R16, $00
		OUT PORTA, R16
		LDI R25, $00
;-----------------------------------------------------------
		LDI R20, 36 ;ENGINE MAX IN PORTC
		LDI R21, 18 ;ENGINE MAX IN PORTD
		LDI R22, 9  ;ENGINE MAX IN PORTB
		LDI R23, 0  ;CHANGED ENGINE
;------------------------------------------------------------
START:	IN R25, PINB
		SBRS R25, 7
		RJMP START
INPUT:	IN R24, PINA
		MOV R29, R24
		LDI R27, $3F
		AND R29, R27
		CPI R24, 00
		BRNE MOT_CH
SAVED:	IN R24, PIND
		CPI R24, $00
		BREQ START
		LDI R27, $00
		SBRC R24, 4;SAVED 1
		RJMP SAVED1
		SBRC R24, 5;SAVED 2
		RJMP SAVED2
		SBRC R24, 6;SAVED 3
		RJMP SAVED3
		SBRC R24, 7;SAVED 4
		RJMP SAVED4
		RJMP START
MOT_CH:	SBRC R25, 4 ;MOTOR CHECK + REVERSE MODE CHECK 
		RJMP RECHECKC4
		SBRC R25, 5
		RJMP RECHECKD4
		SBRC R25, 6
		RJMP RECHECKB4
SAVED1:	LDI R30, $01 ; 50
		LPM R29, Z
		RJMP MOT_CH
SAVED2:	LDI R30, $02 ; 10
		LPM R29, Z
		RJMP MOT_CH
SAVED3:	LDI R30, $03
		LPM R29, Z
		RJMP MOT_CH
SAVED4: LDI R30, $04
		LPM R29, Z
		RJMP MOT_CH
;-------------------------------------------------
RECHECKC4:SBRS R24,7;
		RJMP C4; IF REVERSE MODE IS OFF
		RJMP C4REVERSE; IF REVERSE MODE IS  ON 
;--------------------------------------------------
RECHECKD4:
		SBRS R24,7;
		RJMP D4; IF REVERSE MODE IS OFF
		RJMP D4REVERSE;IF REVERSE MODE IS ON
;--------------------------------------------------
RECHECKB4:
		SBRS R24,7;
		RJMP B4; IF REVERSE MODE IS OFF
		RJMP B4REVERSE;IF REVERSE MODE IS ON
;--------------------------------------------------
C4REVERSE:CP R29, R20
		BRSH C_SET
C_CON:	LDI R16, $04
C_1:	OUT PORTC, R16
		LDI R18, 00
		LDI R19, 00
WAIT_C:	INC R18
		WAIT_CP1:INC R19
				CPI R19, $91
				BRNE WAIT_CP1
		CPI R18, $FF
		BRNE WAIT_C
		LSR R16
		CPI R16, $00
		BREQ SHIFT_C
C_BACK:	DEC R29
		CPI R29, $00
		BRNE C_1
LOOP_C:	SBRS R23, 0
		RJMP RESETC
		RJMP START
SHIFT_C:LDI R16, $08
		RJMP C_BACK
C_SET:	MOV R29, R20
		RJMP C_CON		
;+++++++++++++++++++++++++++++++++++++++++++++++
C4:		CP R29, R20
		BRSH C4SET
C4CON:	LDI R16, $01
C1:		OUT PORTC, R16
		LDI R18, 00
		LDI R19, 00
WAITC:	INC R18
		WAITCP1:INC R19
				CPI R19, $91
				BRNE WAITCP1
		CPI R18, $FF
		BRNE WAITC
		LSL R16
		CPI R16, $10
		BREQ SHIFTC
CBACK:	DEC R29
		CPI R29, $00
		BRNE C1
LOOPC:	SBRS R23, 0
		RJMP RESETC
		RJMP START
SHIFTC:	LDI R16, $01
		RJMP CBACK
C4SET:	MOV R29, R20
		RJMP C4CON
;----------------------------------------------------------
;----------------------------------------------------------
D4REVERSE:CP R29, R21
		BRSH D_SET
D_CON:	LDI R16, $04
D_1:	OUT PORTD, R16
		LDI R18, 00
		LDI R19, 00
WAIT_D:	INC R18
		WAIT_DP1:INC R19
				CPI R19, $91
				BRNE WAIT_DP1
		CPI R18, $FF
		BRNE WAIT_D
		OUT PORTC, R27
		LSR R16
		CPI R16, $00
		BREQ SHIFT_D
D_BACK:	DEC R29
		CPI R29, $00
		BRNE D_1
LOOP_D:	SBRS R23, 1
		RJMP RESETD
		RJMP START
SHIFT_D:LDI R16, $08
		RJMP D_BACK
D_SET:	MOV R29, R21
		RJMP D_CON
;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
D4:		CP R29, R21
		BRSH D4SET
D4CON:	LDI R16, $01
D1:		OUT PORTD, R16
		LDI R18, 00
		LDI R19, 00
WAITD:	INC R18
		WAITDP1:INC R19
				CPI R19, $91
				BRNE WAITDP1
		CPI R18, $FF
		BRNE WAITD
		LSL R16
		CPI R16, $10
		BREQ SHIFTD
DBACK:	DEC R29
		CPI R29, $00
		BRNE D1
LOOPD:	SBRS R23, 0
		RJMP RESETD
		RJMP START
SHIFTD:	LDI R16, $01
		RJMP DBACK
D4SET:	MOV R29, R21
		RJMP D4CON
;----------------------------------------------------------
B4REVERSE:CP R29, R22
		BRSH B_SET
B_CON:	LDI R16, $04
B_1:	OUT PORTB, R16
		LDI R18, 00
		LDI R19, 00
WAIT_B:	INC R18
		WAIT_BP1:INC R19
				CPI R19, $91
				BRNE WAIT_BP1
		CPI R18, $FF
		BRNE WAIT_B
		LSR R16
		CPI R16, $00
		BREQ SHIFT_B
B_BACK:	DEC R29
		CPI R29, $00
		BRNE B_1
LOOP_B:	SBRS R23, 0
		RJMP RESETB
		RJMP START
SHIFT_B:LDI R16, $08
		RJMP B_BACK
B_SET:	MOV R29, R22
		RJMP B_CON
;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
B4:		CP R29, R22
		BRSH B4SET
B4CON:	LDI R16, $01
B1:		OUT PORTB, R16
		LDI R18, 00
		LDI R19, 00
WAITB:	INC R18
		WAITBP1:INC R19
				CPI R19, $91
				BRNE WAITBP1
		CPI R18, $FF
		BRNE WAITB
		LSL R16
		CPI R16, $10
		BREQ SHIFTB
BBACK:	DEC R29
		CPI R29, $00
		BRNE B1
LOOPB:	SBRS R23, 0
		RJMP RESETB
		RJMP START
SHIFTB:	LDI R16, $01
		RJMP BBACK
B4SET:	MOV R29, R22
		RJMP B4CON
;----------------------------------------------------------reset bottun \/
RESETC:	IN R25, PINB
		SBRS R25, 7
		RJMP RESETC
		LDI R23, $FF;FLAG FOR RESET
		MOV R29, R24
		LDI R27, $3F
		AND R29, R27
		SBRS R24,7;
		RJMP C4RE ; IF REVERSE MODE IS  ON
		RJMP C4RERE; IF REVERSE MODE IS OFF
RESETD:	IN R25, PINB
		SBRS R25, 7
		RJMP RESETD
		LDI R23, $FF
		MOV R29, R24
		LDI R27, $3F
		AND R29, R27
		DEC R29
		SBRS R24,7;
		RJMP D4REVERSE ; IF REVERSE MODE IS  ON
		RJMP D4; IF REVERSE MODE IS OFF
RESETB:	IN R25, PINB
		SBRS R25, 7
		RJMP RESETB
		LDI R23, $FF
		MOV R29, R24
		LDI R27, $3F
		AND R29, R27
		DEC R29
		SBRS R24,7;
		RJMP B4REVERSE ; IF REVERSE MODE IS  ON
		RJMP B4; IF REVERSE MODE IS OFF
;--------------------------------------------------
C4RERE:	CP R29, R20
		BRSH C_SETRE
C4RERECON:LSL R16
C_1RE:	OUT PORTC, R16
		LDI R18, 00
		LDI R19, 00
WAIT_CRE:INC R18
		WAIT_CP1RE:INC R19
				CPI R19, $91
				BRNE WAIT_CP1RE
		CPI R18, $FF
		BRNE WAIT_CRE
		OUT PORTC, R27
		LSR R16
		CPI R16, $00
		BREQ SHIFT_CRE
C_BACKRE:DEC R29
		CPI R29, $00
		BRNE C_1RE
		RJMP START
SHIFT_CRE:LDI R16, $08
		RJMP C_BACKRE
C_SETRE:MOV R29, R20
		RJMP C4RERECON		
;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
C4RE:	CP R29, R20
		BRSH C4SETRE
C4CONRE:LSL R16
C1RE:	OUT PORTC, R16
		LDI R18, 00
		LDI R19, 00
WAITCRE:INC R18
		WAITCP1RE:INC R19
				CPI R19, $91
				BRNE WAITCP1RE
		CPI R18, $FF
		BRNE WAITCRE
		LSL R16
		CPI R16, $10
		BREQ SHIFTCRE
CBACKRE:DEC R29
		CPI R29, $00
		BRNE C1RE
		RJMP START
SHIFTCRE:LDI R16, $01
		RJMP CBACKRE
C4SETRE:MOV R29, R20
		RJMP C4CONRE
;----------------------------------------------------------